/* Query 1 - query used for first insight*/
SELECT
  film_title,
  category_name,
  COUNT(*) AS rental_count
FROM (SELECT
  f.title film_title,
  c.name category_name,
  r.rental_id rental
FROM film f
JOIN film_category fc
  ON f.film_id = fc.film_id
JOIN category c
  ON c.category_id = fc.category_id
JOIN inventory i
  ON i.film_id = f.film_id
JOIN rental r
  ON i.inventory_id = r.inventory_id
WHERE c.name IN ('Animation', 'Children', 'Classics', 'Comedy', 'Family', 'Music')) t1

GROUP BY 1, 2
ORDER BY 2, 1;

/*Query 2 - query used for the second insight*/

SELECT
  category_name,
  standard_quartile,
  COUNT(*)
FROM (SELECT
  c.name category_name,
  f.rental_duration rental_duration,
  NTILE(4) OVER (ORDER BY rental_duration) AS standard_quartile
FROM film f
JOIN film_category fc
  ON f.film_id = fc.film_id
JOIN category c
  ON c.category_id = fc.category_id
WHERE c.name IN ('Animation', 'Children', 'Classics', 'Comedy', 'Family', 'Music')) t1

GROUP BY 1, 2
ORDER BY 1, 2;

/* Query 3 - query used for the third insight */

SELECT
	DATE_PART('month', rental_date) Rental_month,
	DATE_PART('year', rental_date) Rental_year,
	st.store_id Store_ID,
	COUNT(*) Count_rental
FROM rental r
JOIN staff sf
	ON r.staff_id = sf.staff_id
JOIN store st
	ON st.store_id = sf.store_id

GROUP BY 1,2,3
ORDER BY 4 DESC;

/* Query 4 - query used for the fourth insight */

WITH t1 AS(
	 SELECT CONCAT(first_name,' ', last_name) AS full_name,
       		      SUM(p.amount) amount,
  		      c.customer_id customer_id
	 FROM customer c
	 JOIN payment p
	 ON p.customer_id = c.customer_id
           GROUP BY 1,3
  	 ORDER BY 2 DESC
	 LIMIT 10) 
     
SELECT t1.full_name, 		   
       DATE_TRUNC('month',p.payment_date) pay_mon,
       COUNT(*) AS pay_countpermon, 	        	
       SUM(p.amount) total_amount
FROM payment p
JOIN t1
ON t1.customer_id = p.customer_id
WHERE p.payment_date BETWEEN '20070101' AND '20080101'

GROUP BY 1,2
ORDER BY 1,2,3 ;